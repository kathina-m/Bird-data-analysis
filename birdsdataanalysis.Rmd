---
title: "Analysis_birdsdata"
author: "Cheyenne, Kathina & Lina"
date: "4/7/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

This document have been created to include all relevant parts in the analysis of our animal diversity project.

##Data preparation and data observation

The first code's chunk will be used to load all libraries needed to proceed. 
```{r}
library(tidyverse)
library(vegan)
library(nlme)
library(MASS)
library(MuMIn)
```

In this second chunk, the data to be used will be loaded into a data frame and transferred into adequate data types.

```{r}
dat <- read.csv("data/birds_dataset.csv", sep=";")
dat$category <- as.factor(dat$category)
dat$site <- as.factor(dat$site)
```

Following, species richness, species abundance and rarefied richness of species will be calculated.

```{r}
dat$species_richness <- specnumber(dat[,4:31]) #species richness
dat$species_abund <- rowSums(dat[,4:31]) #abundances
dat$rarefied_richness <- rarefy(dat[,4:31],min(dat$species_abund)) #rarefied richness based on the subsample with the lowest number of individuals

```

After, data is observed comparing the plots from parks and forests.

```{r}
boxplot(species_richness~category, data=dat)
boxplot(log(species_abund+1)~category, data=dat)
boxplot(rarefied_richness~category, data=dat)

```

##Now let's begin with the data analysis

#2a linear models: to check for difference between habitat types with the implementation of mixed effect models.
```{r}

mod1 <- lme(species_richness~category, random = (~1|site), data=dat) #model structure, random=... specifies how the data are structured (subsamples nested in study site)
summary(mod1) #model output - important is the "fixed effects" part. Here "forest" is hiding in the "Intercept" and the categorypark-row is showing the difference between park and forest
plot(mod1) #check for homogeneity of variances (data points should have similar vertical spread along the x-axis)
qqnorm(mod1, ~resid(.,type="p"), abline = c(0,1)) #check for normality of residuals (should not be completely off the line)
```


#2b linear models to include environmental variables and see the variation of the data with each of them. 

```{r}
### MIXED EFFECTS MODEL WITH SPECIES RICHNESS

round(cor(dat[,32:45]),2) #check which predictor variables are strongly correlated (below -0.7 or above 0.7) - highly correlated variables should not be included together in the same model (select only one of them, e.g. the one more strongly related to the response variable)

mod2 <- lme(species_richness ~ category*size + canopy_cover + n_tree_spec + n_tree_ind + log(dbh_min) + n_microhabitats + temperature, random = (~1|site), data=dat, method="ML") #initial, full model with all potential predictor variables
summary(mod2)

mod3 <- stepAIC(mod2) #model simplification based on AIC-value of the model
summary(mod3) #final model which includes only the most important predictors 
mod4 <- update(mod3, ~.-n_tree_spec)
summary(mod4)
anova(mod3, mod4)
mod5 <- update(mod4, ~.-temperature)
summary(mod5)
anova(mod4, mod5) #close to significcance effect with these variables (species increasing with increasing dbh min.) 
mod6 <- update(mod5, ~.-canopy_cover)
summary(mod6)
anova(mod5,mod6)

#final model:
#lme(species_richness ~ log(dbh_min), random = (~1|site), data=dat, method="ML")
#https://jonlefcheck.net/2013/03/13/r2-for-linear-mixed-effects-models/
r.squaredGLMM(mod6)

plot(mod6) #check for homogeneity of variances (data points should have similar vertical spread along the x-axis)
qqnorm(mod6, ~resid(.,type="p"), abline=c(0,1)) #check for normality of residuals (should not be completely off the line)

#standard deviation, coefficient of variation (sd/mean) to make variation independent from out mean value of dbh_mean in this case, and check whether is correlated with the other variables and if this is the case we would need to include it in mod2 and check correlation with (vif for the model)  and cor for correlation

#dat$sddbh_mean <- sd() we can try as alternative
library(car)

vif(mod3)

ggplot(dat,aes(x = dbh_min, y = species_richness)) +
  geom_point() +
  geom_smooth(method = lm, se=TRUE, colour = 'green', size = 1.5, width = 2)

ggplot(dat, aes(x = log(dbh_min), y = species_richness))+
  geom_point() +
  geom_smooth(method = lm,se = TRUE, colour = 'green', size = 1.5) +
  geom_text(x=2.6, y=16, label="p-value: 0.0001", size=3.5) +
  geom_text(x=2.7,y=15.2,label=expression(paste("R"^2,"c: 0.6851")), size=3.5) +
  labs(x="log(mininmal dbh [cm])", y="actual species richness")

### MIXED EFFECTS MODEL WITH BIRD ABUNDANCE
mod2 <- lme(species_abund ~ category*size + canopy_cover + n_tree_spec + n_tree_ind + log(dbh_min) + n_microhabitats + temperature, random = (~1|site), data=dat, method="ML") #initial, full model with all potential predictor variables
summary(mod2)

mod3 <- stepAIC(mod2) #model simplification based on AIC-value of the model
summary(mod3) #final model which includes only the most important predictors 
mod4 <- update(mod3, ~.-size)
summary(mod4)
anova(mod3, mod4)
mod5<-update(mod4, ~.-log(dbh_min))
summary(mod5)

# plot model for abundance vs. canopy cover
mod_can<-lme(species_abund ~ canopy_cover, random = (~1|site), data=dat, method="ML")
r.squaredGLMM(mod_can)
  
ggplot(dat, aes(x = canopy_cover, y = species_abund))+
  geom_point() +
  geom_smooth(method = lm, se = TRUE, colour = 'green', size = 1.5) +
  geom_text(x=70, y=35, label="p-value: 0.0015", size=3.5) +
  geom_text(x=72,y=33.5, label=expression(paste("R"^2,"c: 0.5312")), size=3.5) +
  labs(x="canopy cover [%]", y="actual species abundance")

# plot model for abundance vs. microhabitats
mod_mic<-lme(species_abund ~ n_microhabitats, random = (~1|site), data=dat, method="ML")
r.squaredGLMM(mod_mic)
  
ggplot(dat, aes(x = n_microhabitats, y = species_abund))+
  geom_point() +
  geom_smooth(method = lm, se = TRUE, colour = 'green', size = 1.5) +
  geom_text(x=15, y=35, label="p-value: 0.0098", size=3.5) +
  geom_text(x=14.15,y=33.5, label=expression(paste("R"^2,"c: 0.5755")), size=3.5) +
  labs(x="number of microhabitats", y="actual species abundance")

### MIXED EFFECTS MODEL WITH RAREFIED RICHNESS
mod2 <- lme(rarefied_richness ~ category*size + canopy_cover + n_tree_spec + n_tree_ind + log(dbh_min) + n_microhabitats + temperature, random = (~1|site), data=dat, method="ML") #initial, full model with all potential predictor variables
summary(mod2)

mod3 <- stepAIC(mod2) #model simplification based on AIC-value of the model
summary(mod3) #final model which includes only the most important predictors 

# plot model for rarefied richness vs. min dbh
mod_dbh<-lme(rarefied_richness ~ log(dbh_min), random = (~1|site), data=dat, method="ML")
r.squaredGLMM(mod3)
  
ggplot(dat, aes(x = rarefied_richness, y = log(dbh_min)))+
  geom_point() +
  geom_smooth(method = lm, se = TRUE, colour = 'green', size = 1.5) +
  geom_text(x=70, y=35, label="p-value: 0.0223", size=3.5) +
  geom_text(x=72,y=33.5, label=expression(paste("R"^2,"c: 0.4573")), size=3.5) +
  labs(x="log(minimal dbh [cm])", y="rarefied species richness")

#plot(log(dbh_min)~rarefied_richness, data=dat, ylim=c(0,5))
#mod<-lm(rarefied_richness ~ log(dbh_min), data=dat, poly(degree = 2))
```


##2c Ordination with NMDS (to look for differences in species composition)
```{r out.width = "100%"}
nmd1 <- metaMDS(dat[,4:31], distance="horn", k=2) #NMDS analysis based on Morisita-Horn-Index as a dissimilarity measure
# orditkplot(nmd1, display = "species", col = "darkred", fill = NA, border = NA, cex = 0.6)
ordiplot(nmd1, choices = c(1, 2), type = "n") # ylim = c(-0.75, 0.5), xlim = c(-1.25, 1.3))
ordilabel(nmd1, display = "species", col = "darkred", fill = NA, border = NA, cex = 0.5)
points(nmd1, pch=c(16, 17)[as.numeric(as.factor(dat$category))], col = "darkblue") #add sampling points
legend("topright", pch = c(16, 17), c("Forest","Park"), col = "darkblue", cex = 0.7) #add legend

ef <- envfit(nmd1, dat[,32:44]) #check for correlation of dissimilarity gradients with environmental variables
ef #results
plot(ef, p.max=0.05, col = "darkblue", cex = 0.7) #add significant environmental variables to the NMDS plot
```

Now the species accumulation curve is shown.
```{r}
SAC_park <- specaccum(subset(dat[,4:31], dat$category == "park"))
SAC_fore <- specaccum(subset(dat[,4:31], dat$category == "forest"))

plot(SAC_park, xlab = "plots", ylab = "species richness", main="species accumulation curve")

plot(SAC_fore, xlab = "plots", ylab = "species richness", main="species accumulation curve", col="green", add = T)
legend("bottomright", legend = c("park","forest"), col = c("black","green"), lwd=1, bty = "n")
```


Analysis of bird's diversity and the variables measured from these two types of ecosystems.

```{r}
parks <- read.csv("data/parks.csv", sep=";")
forest <- read.csv("data/forest.csv", sep=";")
alpha <- specnumber(dat[,4:31]) # or use the binary site-species matrix
gamma <- ncol(dat[,colSums(dat[,4:31])>0])

##Lande’s index  (beta) diversity
gamma - mean(alpha)

##Whittaker’s index

#gamma/mean(alpha)


#For parks

alphap <- specnumber(parks[,4:31])

gammap <- ncol(parks[,colSums(parks[,4:31]) > 0])

##Lande’s index 
gammap - mean(alphap)

##Whittaker’s index

#gammap/mean(alphap)

#For forest
alphaf <- specnumber(forest[,4:31])

gammaf <- ncol(parks[,colSums(parks[,4:31]) > 0])

##Lande’s index 
gammaf - mean(alphaf)

##Whittaker’s index

#gammaf/mean(alphaf)
```
The number of shared and unique species for a given for the two plots combine and separated.
```{r}
beta_virt <- betadiver(dat[,4:31], method = NA)
# a
beta_virt$a
beta_virt$b
beta_virt$c
 
plot(betadiver(dat[,4:31], method=NA), pch = 16, cex = 2,)
legend("topleft", legend = "Virtual matrix", bty = "n")

beta_virtp <- betadiver(parks, method = NA)
# a
beta_virtp$a
beta_virtp$b
beta_virtp$c
 
plot(betadiver(parks, method=NA), pch = 16, cex = 2,)
legend("topleft", legend = "Virtual matrix", bty = "n")
               
#vennd iagram <- as alternative to show the overlap of shared species    
```
We can see how nice heterogeneity is present between the two ecosystems

Now the similarity between plots by Sorensen, Simpson and Jaccard

```{r}


#Sorensen similarity
sorparks <-  betadiver(parks[,4:31], method = "sor")
sorensen <-  as.matrix(sorparks)[,]
plot(sorensen)

#Simpson similarity
simpark<- betadiver(parks[,4:31], method = "sim")
simpsonpark <- as.matrix(simpark)[,]
plot(simpsonpark)

# Jaccard similarity
jparks <- betadiver(parks[,1:31], method = "j")
plot(as.matrix(jparks)[,])

#Sorensen similarity
sorforest <-  betadiver(forest[,4:31], method = "sor")
sorensenforest <-  as.matrix(sorforest)[,]
plot(sorensen)

#Simpson similarity
simf <- betadiver(forest[,4:31], method = "sim")
simpson <- as.matrix(simf)[,]
plot(simpson)


# Jaccard similarity

jforest <- betadiver(forest[,4:31], method = "j")
as.matrix(jforest)[,]

plot(as.matrix(jforest)[,])

#calculate mean of these similarities indices and compare between sites

```

RANK abundance curve <- takes the most abundance species and plot it against species abundance rank

```{r}
plot1_1 <- data.frame(sp = colnames(dat[,4:31]),
                       ab = as.numeric(dat[1,4:31]))

# Add rank of species in the first community
plot1_1$rank <- rank(-plot1_1$ab, ties.method = "random")
# Ordering data before plotting
plot1_1 <- plot1_1[order(plot1_1$rank), ]
# Plot
plot(plot1_1$rank, plot1_1$ab, type = "b",
     col = rgb(grey), pch = 16, lwd = 1,
     main = "RAD",
     xlab = "Rank", ylab = "Abundances")

plot1_2 <- data.frame(sp = colnames(dat[,4:31]),
                       ab = as.numeric(dat[2,4:31]))
plot1_2$rank <- rank(-plot1_2$ab, ties.method = "random")
plot1_2 <- plot1_2[order(plot1_2$rank), ]
points(plot1_2$rank, plot1_2$ab, type = "b",
     col = "orchid1", pch = 16, lwd = 1)

plot1_3 <- data.frame(sp = colnames(dat[,4:31]),
                       ab = as.numeric(dat[3,4:31]))
plot1_3$rank <- rank(-plot1_3$ab, ties.method = "random")
plot1_3 <- plot1_3[order(plot1_3$rank), ]
points(plot1_3$rank, plot1_3$ab, type = "b",
     col = "steelblue1", pch = 16, lwd = 1)


plot2_1 <- data.frame(sp = colnames(dat[,4:31]),
                       ab = as.numeric(dat[4,4:31]))
plot2_1$rank <- rank(-plot2_1$ab, ties.method = "random")
plot2_1 <- plot2_1[order(plot2_1$rank), ]
points(plot2_1$rank, plot2_1$ab, type = "b",
     col = "orange2", pch = 16, lwd = 1)

plot2_2 <- data.frame(sp = colnames(dat[,4:31]),
                       ab = as.numeric(dat[5,4:31]))
plot2_2$rank <- rank(-plot2_2$ab, ties.method = "random")
plot2_2 <- plot2_2[order(plot2_2$rank), ]
points(plot2_2$rank, plot2_2$ab, type = "b",
     col = "indianred3", pch = 16, lwd = 1)

#... and so on...
```

